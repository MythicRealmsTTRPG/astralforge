<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Campaign Builder • Astral Forge (Admin)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0b0d;
    --panel:rgba(0,0,0,.32);
    --panel2:rgba(0,0,0,.22);
    --text:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.70);
    --border:rgba(255,255,255,.12);
    --gold:#b99054;
    --shadow:rgba(0,0,0,.55);
    --good:#2ecc71;
    --bad:#ff6b6b;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  nav{
    position:fixed; top:0; left:0; right:0;
    z-index:1000;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    background: rgba(0,0,0,.55);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 6px 30px rgba(0,0,0,.45);
  }
  .nav-inner{
    padding:14px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:18px;
    flex-wrap:wrap;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
    text-decoration:none; color:var(--text); white-space:nowrap;
  }
  .brand-text{
    font-family:"Cinzel", serif;
    font-weight:700;
    letter-spacing:.14em;
    font-size:13px;
    text-transform:uppercase;
  }
  .nav-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
  .btn{
    appearance:none;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.20);
    color: rgba(255,255,255,.92);
    padding:10px 12px;
    border-radius:12px;
    font-size:13px;
    cursor:pointer;
    transition:.18s;
    text-decoration:none;
    text-align:center;
    user-select:none;
  }
  .btn:hover{ background: rgba(255,255,255,.06); }
  .btn.gold{
    border-color: rgba(185,144,84,.55);
    background: linear-gradient(135deg, rgba(185,144,84,.18), rgba(0,0,0,.12));
  }
  .btn.gold:hover{ border-color: rgba(185,144,84,.85); transform: translateY(-1px); }

  .pill{
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    color: rgba(255,255,255,.80);
  }
  .pill.ok{ border-color: rgba(46,204,113,.55); color: rgba(46,204,113,.92); }
  .pill.bad{ border-color: rgba(255,107,107,.55); color: rgba(255,107,107,.92); }
  .pill.gold{ border-color: rgba(185,144,84,.55); color: rgba(185,144,84,.92); }

  .wrap{
    padding-top: 92px;
    max-width: 1400px;
    margin: 0 auto;
    padding-left: 20px;
    padding-right: 20px;
    padding-bottom: 40px;
    display:grid;
    grid-template-columns: 280px 1fr 420px;
    gap: 14px;
    align-items:start;
  }

  .sidebar{
    position:sticky;
    top: 102px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 18px 48px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .side-head{
    padding:14px 14px 12px;
    border-bottom: 1px solid rgba(255,255,255,.10);
  }
  .side-head .title{
    font-weight:600;
    letter-spacing:.08em;
    text-transform:uppercase;
    font-size:12px;
    color: rgba(255,255,255,.72);
  }
  .steps{ display:grid; }
  .step{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding: 12px 14px;
    border-bottom: 1px solid rgba(255,255,255,.06);
    cursor:pointer;
    transition:.15s;
  }
  .step:hover{ background: rgba(255,255,255,.05); }
  .step.active{ background: rgba(255,255,255,.07); }
  .step .name{ font-size:14px; color: rgba(255,255,255,.88); }
  .dot{
    width:18px; height:18px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.24);
    display:grid; place-items:center;
    font-size:12px;
    color: rgba(255,255,255,.70);
  }
  .dot.ok{
    border-color: rgba(46,204,113,.55);
    color: rgba(46,204,113,.95);
  }

  .main{
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 18px 48px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .main-head{
    padding:16px 18px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .main-head h1{
    margin:0;
    font-size:16px;
    letter-spacing:.10em;
    text-transform:uppercase;
    color: rgba(255,255,255,.75);
    font-weight:600;
  }
  .main-body{ padding: 18px; }

  .section{
    display:none;
    animation: fade .12s ease;
  }
  .section.active{ display:block; }
  @keyframes fade{ from{opacity:.4; transform:translateY(4px);} to{opacity:1; transform:translateY(0);} }

  .block{
    background: var(--panel2);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 14px;
  }
  .block h2{
    margin:0 0 8px;
    font-family: Georgia, serif;
    font-size: 20px;
    letter-spacing:.01em;
  }
  .help{
    margin:0 0 12px;
    color: var(--muted);
    line-height:1.65;
    font-size: 13px;
  }

  label{
    display:block;
    font-size:12px;
    color: rgba(255,255,255,.70);
    letter-spacing:.12em;
    text-transform:uppercase;
    margin: 12px 0 8px;
  }

  input[type="text"], input[type="number"], input[type="url"], textarea, select{
    width:100%;
    background: rgba(0,0,0,.22);
    color: var(--text);
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 12px;
    padding: 10px 12px;
    outline:none;
    font-size: 14px;
  }
  textarea{ min-height: 120px; resize: vertical; }
  input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.45); }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .row{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .chip{
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    padding: 8px 10px;
    border-radius: 999px;
    font-size: 13px;
    color: rgba(255,255,255,.82);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .chip button{
    border:none; background:transparent; color: rgba(255,255,255,.72);
    cursor:pointer; font-size: 14px; padding:0; line-height:1;
  }

  .warn{
    padding: 12px;
    border-radius: 14px;
    border: 1px solid rgba(185,144,84,.40);
    background: rgba(185,144,84,.10);
    color: rgba(255,255,255,.82);
    font-size: 13px;
    line-height:1.6;
  }

  .footerbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    padding: 14px 18px;
    border-top: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
  }
  .footerbar .muted{ color: rgba(255,255,255,.62); font-size: 12px; }

  .preview{
    position:sticky;
    top: 102px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    box-shadow: 0 18px 48px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .preview-head{
    padding: 16px 18px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .preview-head .t{
    font-weight:600;
    letter-spacing:.10em;
    text-transform:uppercase;
    font-size:12px;
    color: rgba(255,255,255,.70);
  }
  .preview-body{ padding: 16px; }
  .card{
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.22);
    border-radius: 16px;
    overflow:hidden;
  }
  .thumb{
    height: 140px;
    background: radial-gradient(circle at 25% 20%, rgba(255,255,255,.08), rgba(0,0,0,.65));
    border-bottom: 1px solid rgba(255,255,255,.10);
    background-size: cover;
    background-position: center;
  }
  .card-body{ padding: 14px; }
  .meta{
    display:flex; flex-wrap:wrap; gap:8px;
    color: rgba(255,255,255,.70);
    font-size: 12px;
    letter-spacing:.10em;
    text-transform:uppercase;
  }
  .pill2{
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    padding: 6px 8px;
    border-radius: 999px;
  }
  .pill2.gold{
    border-color: rgba(185,144,84,.55);
    background: linear-gradient(135deg, rgba(185,144,84,.16), rgba(0,0,0,.14));
  }
  .card-body h3{
    margin: 10px 0 6px;
    font-family: Georgia, serif;
    font-size: 18px;
  }
  .card-body p{
    margin:0;
    color: rgba(255,255,255,.76);
    line-height:1.6;
    font-size: 13px;
  }
  .kv{
    margin-top: 12px;
    display:grid;
    gap:8px;
    color: rgba(255,255,255,.72);
    font-size: 13px;
  }
  .kv div{ display:flex; justify-content:space-between; gap:10px; }
  .kv strong{ color: rgba(255,255,255,.92); font-weight:600; }

  @media (max-width: 1180px){
    .wrap{ grid-template-columns: 280px 1fr; }
    .preview{ display:none; }
  }
  @media (max-width: 860px){
    .wrap{ grid-template-columns: 1fr; }
    .sidebar{ position:relative; top:auto; }
  }
</style>
</head>

<body>

<nav>
  <div class="nav-inner">
    <a class="brand" href="/">
      <span class="brand-text">Astral Forge • Campaign Builder (Admin)</span>
    </a>

    <div class="nav-actions">
      <span class="pill" id="pillAuth">Auth: unset</span>
      <span class="pill gold" id="pillApi">API: workers.dev</span>
      <span class="pill" id="pillLink">Unlinked</span>

      <button class="btn" id="btnSetApi">API Base</button>
      <button class="btn" id="btnSetToken">Set Token</button>
      <button class="btn" id="btnSaveServer">Save Draft</button>
      <button class="btn gold" id="btnPublish">Publish</button>
      <button class="btn" id="btnOpenPublic">Open Public</button>
    </div>
  </div>
</nav>

<div class="wrap">

  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Builder steps">
    <div class="side-head">
      <div class="title">Sections</div>
    </div>

    <div class="steps" id="steps">
      <div class="step active" data-step="basic"><div class="name">Basic information</div><div class="dot" id="dot-basic">•</div></div>
      <div class="step" data-step="image"><div class="name">Image</div><div class="dot" id="dot-image">•</div></div>
      <div class="step" data-step="seo"><div class="name">Search &amp; social</div><div class="dot" id="dot-seo">•</div></div>
      <div class="step" data-step="booking"><div class="name">Booking</div><div class="dot" id="dot-booking">•</div></div>
      <div class="step" data-step="pricing"><div class="name">Pricing</div><div class="dot" id="dot-pricing">•</div></div>
      <div class="step" data-step="chars"><div class="name">Character creation</div><div class="dot" id="dot-chars">•</div></div>
      <div class="step" data-step="prep"><div class="name">Preparation</div><div class="dot" id="dot-prep">•</div></div>
      <div class="step" data-step="safety"><div class="name">Safety</div><div class="dot" id="dot-safety">•</div></div>
    </div>
  </aside>

  <!-- MAIN -->
  <section class="main">
    <div class="main-head">
      <h1 id="sectionTitle">Basic information</h1>
      <div class="row">
        <button class="btn" id="btnPrev">Prev</button>
        <button class="btn gold" id="btnNext">Next</button>
      </div>
    </div>

    <div class="main-body">

      <!-- BASIC -->
      <div class="section active" id="sec-basic">
        <div class="block">
          <h2>Basic information</h2>
          <p class="help">Core identity. Title, system, hook, and description are what players see first.</p>

          <label for="title">Title</label>
          <input id="title" type="text" maxlength="64" placeholder="Mythic Realms: The Shattered Oath" />

          <div class="grid2">
            <div>
              <label for="type">Format</label>
              <select id="type">
                <option value="campaign">Campaign</option>
                <option value="oneshot">One-shot</option>
                <option value="event">Event</option>
              </select>
            </div>
            <div>
              <label for="system">Game system</label>
              <select id="system">
                <option value="">Select system</option>
                <option>D&amp;D 5e</option>
                <option>Pathfinder 2e</option>
                <option>Call of Cthulhu</option>
                <option>Other</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="levelStart">Game level (start)</label>
              <input id="levelStart" type="number" min="1" max="20" placeholder="3" />
            </div>
            <div>
              <label for="levelEnd">Game level (end)</label>
              <input id="levelEnd" type="number" min="1" max="20" placeholder="10" />
            </div>
          </div>

          <label for="hook">Game hook (1–2 sentences)</label>
          <textarea id="hook" maxlength="150" placeholder="A one- or two-sentence teaser that sets the stakes and vibe."></textarea>

          <label for="description">Game description</label>
          <textarea id="description" maxlength="3000" placeholder="Back-cover copy. Setting, theme, what makes this campaign special, and what players will do."></textarea>

          <div class="grid2">
            <div>
              <label for="language">Language</label>
              <select id="language">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label>Themes (1–8)</label>
              <div class="row">
                <input id="themeInput" type="text" placeholder="Type a theme and press Add (e.g. Horror)" />
                <button class="btn" type="button" id="btnAddTheme">Add</button>
              </div>
              <div class="row" id="themes"></div>
              <p class="help" style="margin-top:10px;">Examples: Epic, Political Intrigue, Dark Fantasy, Mystery, Beginner Friendly.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- IMAGE -->
      <div class="section" id="sec-image">
        <div class="block">
          <h2>Image</h2>
          <p class="help">Use a 16:9 banner. Host in the play repo under <code>/assets/campaigns/</code> and paste the path.</p>

          <div class="warn">
            Only use art you have rights to. If commissioned, add credit info below.
          </div>

          <label for="imagePath">Campaign image path</label>
          <input id="imagePath" type="text" placeholder="/assets/campaigns/mythic-realms.jpg" />

          <label for="artistName">Created by (optional)</label>
          <input id="artistName" type="text" placeholder="Artist name" />

          <label for="artistUrl">Artist URL (optional)</label>
          <input id="artistUrl" type="url" placeholder="https://artist-portfolio.example" />
        </div>
      </div>

      <!-- SEARCH & SOCIAL -->
      <div class="section" id="sec-seo">
        <div class="block">
          <h2>Search &amp; social</h2>
          <p class="help">Preview text when shared/discovered.</p>

          <label for="seoTitle">Title (external)</label>
          <input id="seoTitle" type="text" maxlength="64" placeholder="Mythic Realms — A Living Campaign of Consequences" />

          <label for="seoDesc">Game description (external)</label>
          <textarea id="seoDesc" maxlength="320" placeholder="Short preview description for search results and shares."></textarea>

          <label for="seoImage">Image (external)</label>
          <input id="seoImage" type="text" placeholder="/assets/campaigns/mythic-realms.jpg" />
        </div>
      </div>

      <!-- BOOKING -->
      <div class="section" id="sec-booking">
        <div class="block">
          <h2>Booking</h2>
          <p class="help">What players are committing to.</p>

          <div class="grid2">
            <div>
              <label for="minSessions">Estimated campaign length (min sessions)</label>
              <input id="minSessions" type="number" min="1" placeholder="5" />
            </div>
            <div>
              <label for="maxSessions">Estimated campaign length (max sessions)</label>
              <input id="maxSessions" type="number" min="1" placeholder="30" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="minHours">Session duration (min hours)</label>
              <input id="minHours" type="number" min="1" placeholder="3" />
            </div>
            <div>
              <label for="maxHours">Session duration (max hours)</label>
              <input id="maxHours" type="number" min="1" placeholder="3" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="ageRange">Player age range</label>
              <select id="ageRange">
                <option value="">Select</option>
                <option>13+</option>
                <option>16+</option>
                <option>18+</option>
                <option>All Ages</option>
              </select>
            </div>
            <div>
              <label for="xpLevel">Player experience level</label>
              <select id="xpLevel">
                <option value="">Select</option>
                <option>Beginner-friendly</option>
                <option>Some experience</option>
                <option>Experienced</option>
                <option>Any</option>
              </select>
            </div>
          </div>

          <label for="schedule">Schedule (display text)</label>
          <input id="schedule" type="text" placeholder="Tuesdays • 7:00pm CT • Weekly" />

          <div class="grid2">
            <div>
              <label for="seatsTotal">Seats (total)</label>
              <input id="seatsTotal" type="number" min="1" placeholder="6" />
            </div>
            <div>
              <label for="seatsOpen">Seats (open)</label>
              <input id="seatsOpen" type="number" min="0" placeholder="3" />
            </div>
          </div>
        </div>
      </div>

      <!-- PRICING -->
      <div class="section" id="sec-pricing">
        <div class="block">
          <h2>Pricing</h2>
          <p class="help">Display-only for now; Stripe later.</p>

          <label for="price">Session cost (per player)</label>
          <input id="price" type="text" placeholder="$20 / session" />

          <label for="pricingNotes">Pricing notes (optional)</label>
          <textarea id="pricingNotes" maxlength="1200" placeholder="Billing cadence, missed sessions, etc."></textarea>
        </div>
      </div>

      <!-- CHARACTER CREATION -->
      <div class="section" id="sec-chars">
        <div class="block">
          <h2>Character creation</h2>
          <p class="help">How players build characters, approvals, sources, etc.</p>

          <label for="charCreation">How should players create characters?</label>
          <textarea id="charCreation" maxlength="3000" placeholder="Starting level, allowed sources, stat method, approvals, etc."></textarea>
        </div>
      </div>

      <!-- PREPARATION -->
      <div class="section" id="sec-prep">
        <div class="block">
          <h2>Preparation</h2>
          <p class="help">What players must do before session 1.</p>

          <label for="prepSteps">How should players prepare?</label>
          <textarea id="prepSteps" maxlength="3000" placeholder="Accounts to create, Discord, VTT, what to read, etc."></textarea>

          <label for="gmProvides">What will you provide?</label>
          <textarea id="gmProvides" maxlength="3000" placeholder="What you bring: pacing, ambiance, recaps, maps, etc."></textarea>

          <label for="homebrew">Homebrew rules (optional)</label>
          <textarea id="homebrew" maxlength="3000" placeholder="Potion rules, crit rules, downtime, etc."></textarea>

          <label>Equipment needed</label>
          <div class="row">
            <input id="equipInput" type="text" placeholder="Type an item and press Add (e.g. Microphone)" />
            <button class="btn" type="button" id="btnAddEquip">Add</button>
          </div>
          <div class="row" id="equipment"></div>

          <label>Platforms</label>
          <div class="row">
            <input id="platInput" type="text" placeholder="Type a platform and press Add (e.g. Discord)" />
            <button class="btn" type="button" id="btnAddPlat">Add</button>
          </div>
          <div class="row" id="platforms"></div>
        </div>
      </div>

      <!-- SAFETY -->
      <div class="section" id="sec-safety">
        <div class="block">
          <h2>Safety</h2>
          <p class="help">Safety tools, content warnings, and comfort expectations.</p>

          <label for="safetyPlan">How will you keep your players safe and comfortable?</label>
          <textarea id="safetyPlan" maxlength="3000" placeholder="Session 0, lines & veils, X-card, open door, aftercare, etc."></textarea>

          <label>Content warnings</label>
          <div class="row">
            <input id="cwInput" type="text" placeholder="Type a warning and press Add (e.g. body horror)" />
            <button class="btn" type="button" id="btnAddCW">Add</button>
          </div>
          <div class="row" id="contentWarnings"></div>

          <label>Safety tools</label>
          <div class="row">
            <label style="margin:0; font-size:13px; letter-spacing:0; text-transform:none; color:rgba(255,255,255,.82);">
              <input type="checkbox" class="sTool" value="Session 0"> Session 0
            </label>
            <label style="margin:0; font-size:13px; letter-spacing:0; text-transform:none; color:rgba(255,255,255,.82);">
              <input type="checkbox" class="sTool" value="Lines & Veils"> Lines & Veils
            </label>
            <label style="margin:0; font-size:13px; letter-spacing:0; text-transform:none; color:rgba(255,255,255,.82);">
              <input type="checkbox" class="sTool" value="X, N, and O Cards"> X, N, and O Cards
            </label>
            <label style="margin:0; font-size:13px; letter-spacing:0; text-transform:none; color:rgba(255,255,255,.82);">
              <input type="checkbox" class="sTool" value="Open Door"> Open Door
            </label>
            <label style="margin:0; font-size:13px; letter-spacing:0; text-transform:none; color:rgba(255,255,255,.82);">
              <input type="checkbox" class="sTool" value="Breaks"> Breaks
            </label>
          </div>

          <div style="margin-top:12px;" class="warn">
            Admin-only page. Keep your token private.
          </div>
        </div>
      </div>

    </div>

    <div class="footerbar">
      <div class="muted" id="saveStatus">Ready.</div>
      <div class="row">
        <button class="btn" id="btnClearLocal">Clear Local Draft</button>
      </div>
    </div>
  </section>

  <!-- PREVIEW -->
  <aside class="preview">
    <div class="preview-head">
      <div class="t">Preview</div>
      <button class="btn" id="btnCopySlug" title="Copy suggested slug">Copy slug</button>
    </div>
    <div class="preview-body">
      <div class="card">
        <div class="thumb" id="pvThumb"></div>
        <div class="card-body">
          <div class="meta">
            <span class="pill2" id="pvSystem">System</span>
            <span class="pill2" id="pvSchedule">Schedule</span>
            <span class="pill2 gold" id="pvStatus">Draft</span>
          </div>
          <h3 id="pvTitle">Campaign title</h3>
          <p id="pvHook">Your hook will appear here.</p>

          <div class="kv">
            <div><span>Seats</span><strong id="pvSeats">—</strong></div>
            <div><span>Price</span><strong id="pvPrice">—</strong></div>
            <div><span>Level</span><strong id="pvLevel">—</strong></div>
          </div>
        </div>
      </div>

      <div style="height:12px;"></div>

      <div class="warn">
        <strong>Publish flow:</strong> Save Draft → stores in D1. Publish → sets status to published and opens the public campaign page.
      </div>
    </div>
  </aside>

</div>

<script>
  // ---------------------------
  // ADMIN CONFIG (IMPORTANT)
  // ---------------------------
  const API_BASE_DEFAULT = "https://astralforge-api.scalescribe-mythicrealms.workers.dev";
  const KEY_LOCAL_DRAFT = "af_builder_local_draft_v1";
  const KEY_ADMIN_TOKEN = "af_admin_token";
  const KEY_API_BASE = "af_api_base";
  const KEY_CAMPAIGN_ID = "af_current_campaign_id";
  const KEY_CAMPAIGN_SLUG = "af_current_campaign_slug";

  const el = (id) => document.getElementById(id);

  function getApiBase(){
    return (localStorage.getItem(KEY_API_BASE) || API_BASE_DEFAULT).replace(/\/+$/, "");
  }
  function setApiBase(v){
    localStorage.setItem(KEY_API_BASE, v.replace(/\/+$/, ""));
    syncPills();
  }

  function getToken(){ return localStorage.getItem(KEY_ADMIN_TOKEN) || ""; }
  function setToken(v){ localStorage.setItem(KEY_ADMIN_TOKEN, v); syncPills(); }
  function clearToken(){ localStorage.removeItem(KEY_ADMIN_TOKEN); syncPills(); }

  function getLinkedId(){ return localStorage.getItem(KEY_CAMPAIGN_ID) || ""; }
  function setLinked(id, slug){
    localStorage.setItem(KEY_CAMPAIGN_ID, id);
    localStorage.setItem(KEY_CAMPAIGN_SLUG, slug);
    syncPills();
  }
  function clearLinked(){
    localStorage.removeItem(KEY_CAMPAIGN_ID);
    localStorage.removeItem(KEY_CAMPAIGN_SLUG);
    syncPills();
  }

  function syncPills(){
    const t = getToken();
    el("pillAuth").textContent = t ? "Auth: set" : "Auth: unset";
    el("pillAuth").className = "pill " + (t ? "ok" : "bad");

    const base = getApiBase();
    el("pillApi").textContent = base.includes("api.astralforge.studio") ? "API: api.astralforge.studio" : "API: workers.dev";

    const id = getLinkedId();
    const slug = localStorage.getItem(KEY_CAMPAIGN_SLUG) || "";
    el("pillLink").textContent = id ? ("Linked: " + (slug || id.slice(0,8))) : "Unlinked";
    el("pillLink").className = "pill " + (id ? "ok" : "");
  }

  async function apiFetch(path, method="GET", body=null){
    const url = getApiBase() + path;
    const headers = { "Content-Type": "application/json" };
    const token = getToken();
    if(token) headers["Authorization"] = "Bearer " + token;

    const res = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = { ok:false, error:"Bad JSON from server", raw:text }; }

    if(!res.ok || !data?.ok) {
      const msg = data?.error || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function toast(msg){
    el("saveStatus").textContent = msg;
  }

  // ---------------------------
  // BUILDER STATE
  // ---------------------------
  const steps = [
    {key:"basic", title:"Basic information"},
    {key:"image", title:"Image"},
    {key:"seo", title:"Search & social"},
    {key:"booking", title:"Booking"},
    {key:"pricing", title:"Pricing"},
    {key:"chars", title:"Character creation"},
    {key:"prep", title:"Preparation"},
    {key:"safety", title:"Safety"},
  ];

  const inputs = {
    title: el("title"),
    type: el("type"),
    system: el("system"),
    levelStart: el("levelStart"),
    levelEnd: el("levelEnd"),
    hook: el("hook"),
    description: el("description"),
    language: el("language"),

    imagePath: el("imagePath"),
    artistName: el("artistName"),
    artistUrl: el("artistUrl"),

    seoTitle: el("seoTitle"),
    seoDesc: el("seoDesc"),
    seoImage: el("seoImage"),

    minSessions: el("minSessions"),
    maxSessions: el("maxSessions"),
    minHours: el("minHours"),
    maxHours: el("maxHours"),
    ageRange: el("ageRange"),
    xpLevel: el("xpLevel"),
    schedule: el("schedule"),
    seatsTotal: el("seatsTotal"),
    seatsOpen: el("seatsOpen"),

    price: el("price"),
    pricingNotes: el("pricingNotes"),

    charCreation: el("charCreation"),

    prepSteps: el("prepSteps"),
    gmProvides: el("gmProvides"),
    homebrew: el("homebrew"),

    safetyPlan: el("safetyPlan"),
  };

  let themes = [];
  let equipment = [];
  let platforms = [];
  let contentWarnings = [];

  function slugify(str){
    return (str || "")
      .toLowerCase()
      .trim()
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/^-+|-+$/g,"")
      .slice(0, 64);
  }

  function getSafetyTools(){
    return Array.from(document.querySelectorAll(".sTool:checked")).map(x => x.value);
  }

  function setSafetyTools(values){
    const set = new Set(values || []);
    document.querySelectorAll(".sTool").forEach(cb => cb.checked = set.has(cb.value));
  }

  function collect(){
    return {
      version: 1,
      updatedAt: new Date().toISOString(),
      slug: slugify(inputs.title.value),
      basic: {
        title: inputs.title.value.trim(),
        type: inputs.type.value,
        system: inputs.system.value,
        levelStart: inputs.levelStart.value ? Number(inputs.levelStart.value) : null,
        levelEnd: inputs.levelEnd.value ? Number(inputs.levelEnd.value) : null,
        hook: inputs.hook.value.trim(),
        description: inputs.description.value.trim(),
        language: inputs.language.value,
        themes: themes.slice(0, 8),
      },
      image: {
        path: inputs.imagePath.value.trim(),
        artistName: inputs.artistName.value.trim(),
        artistUrl: inputs.artistUrl.value.trim(),
      },
      seo: {
        title: inputs.seoTitle.value.trim(),
        description: inputs.seoDesc.value.trim(),
        image: inputs.seoImage.value.trim(),
      },
      booking: {
        minSessions: inputs.minSessions.value ? Number(inputs.minSessions.value) : null,
        maxSessions: inputs.maxSessions.value ? Number(inputs.maxSessions.value) : null,
        minHours: inputs.minHours.value ? Number(inputs.minHours.value) : null,
        maxHours: inputs.maxHours.value ? Number(inputs.maxHours.value) : null,
        ageRange: inputs.ageRange.value,
        experienceLevel: inputs.xpLevel.value,
        schedule: inputs.schedule.value.trim(),
        seatsTotal: inputs.seatsTotal.value ? Number(inputs.seatsTotal.value) : null,
        seatsOpen: inputs.seatsOpen.value ? Number(inputs.seatsOpen.value) : null,
      },
      pricing: {
        price: inputs.price.value.trim(),
        notes: inputs.pricingNotes.value.trim(),
      },
      characterCreation: {
        details: inputs.charCreation.value.trim(),
      },
      preparation: {
        steps: inputs.prepSteps.value.trim(),
        gmProvides: inputs.gmProvides.value.trim(),
        homebrew: inputs.homebrew.value.trim(),
        equipment: equipment.slice(),
        platforms: platforms.slice(),
      },
      safety: {
        plan: inputs.safetyPlan.value.trim(),
        contentWarnings: contentWarnings.slice(),
        tools: getSafetyTools(),
      }
    };
  }

  function apply(data){
    const d = data || {};
    const b = d.basic || {};
    inputs.title.value = b.title || "";
    inputs.type.value = b.type || "campaign";
    inputs.system.value = b.system || "";
    inputs.levelStart.value = (b.levelStart ?? "") === null ? "" : (b.levelStart ?? "");
    inputs.levelEnd.value = (b.levelEnd ?? "") === null ? "" : (b.levelEnd ?? "");
    inputs.hook.value = b.hook || "";
    inputs.description.value = b.description || "";
    inputs.language.value = b.language || "en";
    themes = Array.isArray(b.themes) ? b.themes.slice(0,8) : [];

    const img = d.image || {};
    inputs.imagePath.value = img.path || "";
    inputs.artistName.value = img.artistName || "";
    inputs.artistUrl.value = img.artistUrl || "";

    const seo = d.seo || {};
    inputs.seoTitle.value = seo.title || "";
    inputs.seoDesc.value = seo.description || "";
    inputs.seoImage.value = seo.image || "";

    const bk = d.booking || {};
    inputs.minSessions.value = bk.minSessions ?? "";
    inputs.maxSessions.value = bk.maxSessions ?? "";
    inputs.minHours.value = bk.minHours ?? "";
    inputs.maxHours.value = bk.maxHours ?? "";
    inputs.ageRange.value = bk.ageRange || "";
    inputs.xpLevel.value = bk.experienceLevel || "";
    inputs.schedule.value = bk.schedule || "";
    inputs.seatsTotal.value = bk.seatsTotal ?? "";
    inputs.seatsOpen.value = bk.seatsOpen ?? "";

    const pr = d.pricing || {};
    inputs.price.value = pr.price || "";
    inputs.pricingNotes.value = pr.notes || "";

    const cc = d.characterCreation || {};
    inputs.charCreation.value = cc.details || "";

    const p = d.preparation || {};
    inputs.prepSteps.value = p.steps || "";
    inputs.gmProvides.value = p.gmProvides || "";
    inputs.homebrew.value = p.homebrew || "";
    equipment = Array.isArray(p.equipment) ? p.equipment.slice() : [];
    platforms = Array.isArray(p.platforms) ? p.platforms.slice() : [];

    const s = d.safety || {};
    inputs.safetyPlan.value = s.plan || "";
    contentWarnings = Array.isArray(s.contentWarnings) ? s.contentWarnings.slice() : [];
    setSafetyTools(s.tools || []);

    renderChips();
    updatePreview();
    updateDots();
  }

  function saveLocalDraft(){
    const data = collect();
    localStorage.setItem(KEY_LOCAL_DRAFT, JSON.stringify(data));
    toast("Local draft saved • " + new Date().toLocaleString());
    updateDots();
  }

  function loadLocalDraft(){
    const raw = localStorage.getItem(KEY_LOCAL_DRAFT);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch{ return null; }
  }

  function renderChipList(containerId, items, onRemove){
    const wrap = el(containerId);
    wrap.innerHTML = "";
    items.forEach((t, idx) => {
      const c = document.createElement("div");
      c.className = "chip";
      c.innerHTML = `<span>${escapeHtml(t)}</span>`;
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = "×";
      b.addEventListener("click", () => onRemove(idx));
      c.appendChild(b);
      wrap.appendChild(c);
    });
  }

  function renderChips(){
    renderChipList("themes", themes, (i)=>{ themes.splice(i,1); renderChips(); updatePreview(); updateDots(); });
    renderChipList("equipment", equipment, (i)=>{ equipment.splice(i,1); renderChips(); updatePreview(); updateDots(); });
    renderChipList("platforms", platforms, (i)=>{ platforms.splice(i,1); renderChips(); updatePreview(); updateDots(); });
    renderChipList("contentWarnings", contentWarnings, (i)=>{ contentWarnings.splice(i,1); renderChips(); updatePreview(); updateDots(); });
  }

  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function updatePreview(){
    const data = collect();
    el("pvTitle").textContent = data.basic.title || "Campaign title";
    el("pvHook").textContent = data.basic.hook || "Your hook will appear here.";
    el("pvSystem").textContent = data.basic.system || "System";
    el("pvSchedule").textContent = data.booking.schedule || "Schedule";

    const open = data.booking.seatsOpen;
    const total = data.booking.seatsTotal;
    const status = (typeof open === "number" && open > 0) ? "Open Seats" : (typeof open === "number" ? "Waitlist" : "Draft");
    el("pvStatus").textContent = status;

    const seats = (typeof open === "number" && typeof total === "number") ? `${open}/${total}` : "—";
    el("pvSeats").textContent = seats;
    el("pvPrice").textContent = data.pricing.price || "—";
    const lvl = (data.basic.levelStart || data.basic.levelEnd) ? `${data.basic.levelStart ?? "?"}–${data.basic.levelEnd ?? "?"}` : "—";
    el("pvLevel").textContent = lvl;

    const img = data.image.path || data.seo.image || "";
    const pvThumb = el("pvThumb");
    pvThumb.style.backgroundImage = img
      ? `radial-gradient(circle at 25% 20%, rgba(255,255,255,.08), rgba(0,0,0,.65)), url("${img}")`
      : `radial-gradient(circle at 25% 20%, rgba(255,255,255,.08), rgba(0,0,0,.65))`;
  }

  function isFilled(v){ return !!(v && String(v).trim().length); }

  function updateDots(){
    const data = collect();

    const basicOk =
      isFilled(data.basic.title) &&
      isFilled(data.basic.system) &&
      isFilled(data.basic.hook) &&
      isFilled(data.basic.description);

    const imgOk = isFilled(data.image.path);
    const seoOk = isFilled(data.seo.title) && isFilled(data.seo.description);

    const bookingOk = isFilled(data.booking.schedule) &&
      (typeof data.booking.seatsTotal === "number") &&
      (typeof data.booking.seatsOpen === "number");

    const pricingOk = isFilled(data.pricing.price);
    const charsOk = isFilled(data.characterCreation.details);
    const prepOk = isFilled(data.preparation.steps) && isFilled(data.preparation.gmProvides);
    const safetyOk = isFilled(data.safety.plan) && (data.safety.tools || []).length > 0;

    const map = { basic: basicOk, image: imgOk, seo: seoOk, booking: bookingOk, pricing: pricingOk, chars: charsOk, prep: prepOk, safety: safetyOk };

    Object.entries(map).forEach(([k, ok]) => {
      const dot = el("dot-" + k);
      dot.classList.toggle("ok", !!ok);
      dot.textContent = ok ? "✓" : "•";
    });
  }

  // Step navigation
  let idx = 0;
  function setStep(nextIdx){
    idx = Math.max(0, Math.min(steps.length - 1, nextIdx));
    const key = steps[idx].key;
    el("sectionTitle").textContent = steps[idx].title;

    document.querySelectorAll(".step").forEach(s => s.classList.toggle("active", s.dataset.step === key));
    document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
    el("sec-" + key).classList.add("active");
    window.scrollTo({top: 0, behavior:"smooth"});
  }

  el("steps").addEventListener("click", (e) => {
    const stepEl = e.target.closest(".step");
    if(!stepEl) return;
    const key = stepEl.dataset.step;
    const next = steps.findIndex(s => s.key === key);
    setStep(next);
  });

  el("btnPrev").addEventListener("click", () => setStep(idx - 1));
  el("btnNext").addEventListener("click", () => setStep(idx + 1));

  // Chip add buttons
  el("btnAddTheme").addEventListener("click", () => {
    const v = el("themeInput").value.trim();
    if(!v) return;
    if(themes.length >= 8) return alert("Max 8 themes.");
    themes.push(v);
    el("themeInput").value = "";
    renderChips(); updatePreview(); updateDots();
  });

  el("btnAddEquip").addEventListener("click", () => {
    const v = el("equipInput").value.trim();
    if(!v) return;
    equipment.push(v);
    el("equipInput").value = "";
    renderChips(); updatePreview(); updateDots();
  });

  el("btnAddPlat").addEventListener("click", () => {
    const v = el("platInput").value.trim();
    if(!v) return;
    platforms.push(v);
    el("platInput").value = "";
    renderChips(); updatePreview(); updateDots();
  });

  el("btnAddCW").addEventListener("click", () => {
    const v = el("cwInput").value.trim();
    if(!v) return;
    contentWarnings.push(v);
    el("cwInput").value = "";
    renderChips(); updatePreview(); updateDots();
  });

  document.querySelectorAll(".sTool").forEach(cb => cb.addEventListener("change", () => { updatePreview(); updateDots(); }));

  // Live preview updates
  Object.values(inputs).forEach(inp => inp.addEventListener("input", () => { updatePreview(); updateDots(); saveLocalDraft(); }));

  // Slug copy
  el("btnCopySlug").addEventListener("click", async () => {
    const slug = slugify(inputs.title.value);
    try{
      await navigator.clipboard.writeText(slug);
      el("btnCopySlug").textContent = "Copied!";
      setTimeout(()=> el("btnCopySlug").textContent = "Copy slug", 900);
    }catch{
      alert("Slug: " + slug);
    }
  });

  // ---------------------------
  // SERVER SAVE / PUBLISH
  // ---------------------------
  function requireToken(){
    const t = getToken();
    if(!t){
      alert("Set Token first.");
      return false;
    }
    return true;
  }

  function toServerBody(status){
    const data = collect();

    if(!data.basic.title || data.basic.title.length < 3){
      throw new Error("Title is required (min 3 chars).");
    }

    return {
      title: data.basic.title,
      description: data.basic.description || data.basic.hook || "",
      slug: data.slug || undefined,
      status,
      timezone: "UTC",
      seat_capacity: Number.isFinite(data.booking.seatsTotal) ? data.booking.seatsTotal : 6,
      price_cents: null,
      start_at: null,
      end_at: null,
      data_json: data
    };
  }

  async function saveToServer(status){
    if(!requireToken()) return;

    const linkedId = getLinkedId();

    const body = toServerBody(status);

    if(!linkedId){
      const created = await apiFetch("/api/v1/admin/campaigns", "POST", body);
      setLinked(created.id, created.slug);
      toast(`Server saved • ${created.slug} • ${status}`);
      return created.slug;
    } else {
      await apiFetch(`/api/v1/admin/campaigns/${linkedId}`, "PATCH", body);
      // slug may have changed because title changed — keep local copy aligned:
      localStorage.setItem(KEY_CAMPAIGN_SLUG, body.slug || localStorage.getItem(KEY_CAMPAIGN_SLUG) || "");
      toast(`Server updated • ${localStorage.getItem(KEY_CAMPAIGN_SLUG) || linkedId.slice(0,8)} • ${status}`);
      return localStorage.getItem(KEY_CAMPAIGN_SLUG) || "";
    }
  }

  function openPublic(slug){
    if(!slug){
      alert("No slug available yet. Save to server first.");
      return;
    }
    window.open(`/campaigns/${encodeURIComponent(slug)}/`, "_blank");
  }

  // ---------------------------
  // TOP BAR BUTTONS
  // ---------------------------
  el("btnSetToken").addEventListener("click", () => {
    const next = prompt("Enter ADMIN_TOKEN (stored in your browser):", getToken() || "");
    if(next === null) return;
    if(!next.trim()) { clearToken(); toast("Token cleared."); return; }
    setToken(next.trim());
    toast("Token saved.");
  });

  el("btnSetApi").addEventListener("click", () => {
    const next = prompt("API Base URL:", getApiBase());
    if(next === null) return;
    if(!next.trim()) return alert("API Base cannot be empty.");
    setApiBase(next.trim());
    toast("API base saved.");
  });

  el("btnSaveServer").addEventListener("click", async () => {
    try{
      await saveToServer("draft");
    }catch(e){
      alert(e?.message || String(e));
    }
  });

  el("btnPublish").addEventListener("click", async () => {
    try{
      const slug = await saveToServer("published");
      openPublic(slug || collect().slug);
    }catch(e){
      alert(e?.message || String(e));
    }
  });

  el("btnOpenPublic").addEventListener("click", () => {
    const slug = localStorage.getItem(KEY_CAMPAIGN_SLUG) || collect().slug;
    openPublic(slug);
  });

  el("btnClearLocal").addEventListener("click", () => {
    if(!confirm("Clear local draft + unlink server ID for this browser?")) return;
    localStorage.removeItem(KEY_LOCAL_DRAFT);
    clearLinked();
    themes = []; equipment = []; platforms = []; contentWarnings = [];
    setSafetyTools([]);
    Object.values(inputs).forEach(i => i.value = "");
    inputs.type.value = "campaign";
    inputs.language.value = "en";
    renderChips(); updatePreview(); updateDots();
    toast("Cleared local draft and server link.");
  });

  // Init
  const existing = loadLocalDraft();
  if(existing) apply(existing);
  else { renderChips(); updatePreview(); updateDots(); }

  syncPills();
</script>

</body>
</html>
